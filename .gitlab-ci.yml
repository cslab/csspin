# -*- mode: yaml; coding: utf-8 -*-

include:
  - project: qs/cs.template
    ref: v15.9.0.3
    file:
      - ci/common.yml
      - ci/wheel.yml
      - ci/pre-commit.yml
      - ci/release.yml
      - ci/analyze.yml

.python_base:
  image: python:3.9
  needs: []
  before_script:
    - mkdir -p ~/.config/spin
    # Little hack so GitLab won't fudge about the colons.
    # Maybe put that as a CI variable of type "file"?
    - >
      cat > ~/.config/spin/global.yaml << EOF

      python:
        use: python
      sphinx:
        build_dir: _build
      EOF
    - pip install -e .

# --------------------------------- Build stage --------------------------------
wheel:
  extends: [.build_wheel, .python_base]
  script:
    - spin --debug -v --provision python:wheel
    - spin --debug -v docs html
  artifacts:
    when: always
    expire_in: 72 hrs
    paths:
      - dist/*.whl
      - docs/_build/html

# --------------------------------- Test stage ---------------------------------
pre-commit:
  extends: .run_precommit
  needs: []

.test_base:
  needs: []
  script:
    - spin --debug -v --provision test --coverage --cov-report term --cov-report xml:coverage-${CI_JOB_ID}.xml --junitxml=reports-${CI_JOB_ID}/pytest.xml
  artifacts:
    when: always
    expire_in: 24 hrs
    paths:
      - ./coverage*.xml
      - reports*/
    reports:
      junit: reports*/*.xml
      coverage_report:
        coverage_format: cobertura
        path: ./coverage*.xml
  interruptible: true

python3.9:
  extends: [.python_base, .test_base]
  image: python:3.9

python3.10:
  extends: [.python_base, .test_base]
  image: python:3.10

python3.11:
  extends: [.python_base, .test_base]
  image: python:3.11

windows:
  extends: [.test_base]
  tags: ["Powershell", "Python3"]
  before_script:
    - "& 'c:\\program files\\Python311\\python.exe' -m venv venv"
    - venv\Scripts\activate.ps1
    - pip install -e .
  script:
    - spin --debug -v -p pytest.opts="['-k', 'not slow']" --provision test --coverage --cov-report term --cov-report xml:coverage-$env:CI_JOB_ID.xml --junitxml=reports-$env:CI_JOB_ID/pytest.xml

# ---------------------------- Deploy/Analyze stage ----------------------------
analyze:
  extends: .analyze
  variables:
    SOURCE_DIRS: src tests
    PYLINTRC: pyproject.toml
  needs:
    - python3.9
    - python3.10
    - python3.11
    - windows

# ------------------------------- Release stage --------------------------------

.release_deps:
  needs:
    - job: wheel
      artifacts: true
    - job: analyze
      artifacts: false
    - job: python3.9
      artifacts: false
    - job: python3.10
      artifacts: false
    - job: python3.11
      artifacts: false
    - job: windows
      artifacts: false

conpi:
  extends: [.upload_conpi_prod, .release_deps]
  variables:
    PYPI_INDEX: tools/stable

pages:
  extends: [.release_deps]
  image: alpine
  stage: release
  script:
    - mv docs/_build/html public
  artifacts:
    paths:
      - public
  interruptible: false
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v(\d+\.)?\d+\.\d+\.\w+$/'
