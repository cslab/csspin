# -*- mode: yaml; coding: utf-8 -*-

include:
  - project: qs/cs.template
    ref: v15.9.1.0
    file:
      - ci/common.yml
      - ci/pre-commit.yml
      - ci/analyze.yml
  - component: $CI_SERVER_FQDN/qs/ci-templates/twine_upload@0.1.0
    inputs:
      name: pypi-upload
      twine_username: __token__
      twine_password: $TWINE_API_KEY
      wheel_path: dist/csspin-*.whl
      needs:
        - wheel
        - job: analyze
          artifacts: false
        - job: test_spin_ce_integration
          artifacts: false
        - job: test_spin_frontend_integration
          artifacts: false
        - job: test_spin_java_integration
          artifacts: false
        - job: test_spin_python_integration
          artifacts: false
        - job: test_spin_docs_integration
          artifacts: false
        - job: test_spin_conpod_integration
          artifacts: false
        # - job: test_spin_cpp_integration
        #   artifacts: false
        # - job: test_spin_vcs_integration
        #   artifacts: false
      rules:
        - if: $CI_COMMIT_TAG
          when: on_success
        - when: never

variables:
  SPIN_VERBOSE: 1

# --------------------------------- Build stage --------------------------------
wheel:
  stage: build
  image: registry.contact.de/cetest:16.0-7.latest
  variables:
    # The version generation via setuptools_scm needs
    # (potentially) the whole SCM history to work correctly
    GIT_DEPTH: 0
    GIT_STRATEGY: clone
    SPIN_TREE_PYTHON__USE: python
  script:
    - python -m pip install . # FIXME: can't we use python:3.13 and python -m build here?
    - spin provision
    - spin python:wheel
  artifacts:
    when: always
    expire_in: 72 hrs
    paths:
      - dist/*.whl
  interruptible: true

documentation:
  stage: build
  image: registry.contact.de/cetest:16.0-7.latest
  variables:
    SPIN_TREE_PYTHON__USE: python
  script:
    - python -m pip install .
    - spin provision
    - spin docs html
  artifacts:
    when: always
    expire_in: 72 hrs
    paths:
      - doc/_build/html
  interruptible: true

# --------------------------------- Test stage ---------------------------------
pre-commit:
  extends: .run_precommit
  needs: []

.test_base:
  needs: []
  variables:
    SPIN_TREE_PYTHON__USE: python
  script:
    - python -m pip install .
    - spin provision
    - spin test -vv --coverage --with-test-report
  after_script:
    - mkdir reports-${CI_JOB_ID}
    - mv pytest.xml reports-${CI_JOB_ID}/
    - mv python-pytest-coverage.xml python-pytest-${CI_JOB_ID}-coverage.xml
  artifacts:
    when: always
    expire_in: 24 hrs
    paths:
      - ./*coverage*.xml
      - reports*/
    reports:
      junit: reports*/*.xml
      coverage_report:
        coverage_format: cobertura
        path: ./*coverage*.xml
  interruptible: true

python3.9:
  extends: .test_base
  image: python:3.9

python3.10:
  extends: .test_base
  image: python:3.10

python3.11:
  extends: .test_base
  image: python:3.11

python3.12:
  extends: .test_base
  image: python:3.12

python3.13:
  extends: .test_base
  image: python:3.13

windows:
  extends: .test_base
  tags: [Powershell, Python3]
  variables:
    SPIN_TREE_PYTHON__USE: ""
  before_script:
    - "& python.exe -m venv venv"
    - venv\Scripts\activate.ps1
  after_script:
    - Rename-Item python-pytest-coverage.xml python-pytest-$env:CI_JOB_ID-coverage.xml
    - New-Item -ItemType "Directory" reports-$env:CI_JOB_ID
    - Move-Item pytest.xml reports-$env:CI_JOB_ID

# -------------------------- Integration Tests ---------------------------------
.external_integration_base:
  stage: test
  variables:
    PARENT_PIPELINE_ID: $CI_PIPELINE_ID
    TRIGGER_BRANCH: master
  trigger:
    project: $TRIGGER_PROJECT
    branch: $TRIGGER_BRANCH
    strategy: depend
    forward:
      pipeline_variables: true
  needs: [wheel]
  rules:
    - if: "$CI_OPEN_MERGE_REQUESTS"
      when: manual
    - if: "$CI_COMMIT_REF_PROTECTED"
    - when: never

test_spin_ce_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_ce
  extends: .external_integration_base

test_spin_frontend_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_frontend
  extends: .external_integration_base

test_spin_java_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_java
  extends: .external_integration_base

test_spin_python_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_python
  extends: .external_integration_base

test_spin_docs_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_docs
  extends: .external_integration_base

test_spin_conpod_integration:
  variables:
    TRIGGER_PROJECT: qs/spin/spin_conpod
  extends: .external_integration_base

# The following integration tests are currently disabled since those
# plugin-packages are currently not used.
# test_spin_cpp_integration:
#   variables:
#     TRIGGER_PROJECT: qs/spin/spin_cpp
#   extends: .external_integration_base

# test_spin_vcs_integration:
#   variables:
#     TRIGGER_PROJECT: qs/spin/spin_vcs
#   extends: .external_integration_base

# ---------------------------- Deploy/Analyze stage ----------------------------
analyze:
  extends: .analyze
  variables:
    SOURCE_DIRS: src tests
    PYLINTRC: pyproject.toml
  needs:
    - python3.9
    - python3.10
    - python3.11
    - python3.12
    - python3.13
    - windows

# ------------------------------- Release stage --------------------------------

pages:
  needs: [wheel, documentation, analyze]
  image: alpine
  stage: release
  script:
    - mv doc/_build/html public
  artifacts:
    paths:
      - public
  interruptible: false
  rules:
    - if: '$CI_COMMIT_TAG =~ /^v(\d+\.)?\d+\.\d+\.\w+$/'
